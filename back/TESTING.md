# テスト戦略

## テスト対象外のファイル

### 完全に不要なテスト対象

#### マイグレーションスクリプト

- 場所: `migrations/scripts/`
- 理由: 実行時の動作検証が主な目的
- 代替の検証方法: 手動実行による検証
- 注意点: マイグレーションスクリプトはデータベースの構造を変更する重要な操作であり、テストよりも実際の環境での動作確認が重要
- 参考: [Go 公式 FAQ: main 関数のテスト](https://go.dev/doc/faq#main_test)

#### シードデータ

- 場所: `migrations/seeds/`
- 理由: データの整合性チェックが主な目的
- 代替の検証方法: 手動レビューによる検証
- 注意点: シードデータは開発環境やテスト環境の初期データとして使用され、テストよりもデータの正確性が重要

#### テストユーティリティ

- 場所: `internal/testutils/`
- 理由: テストを支援するためのユーティリティであり、それ自体をテストすることは循環依存を引き起こす可能性がある
- 代替の検証方法: 実際のテストでの使用を通じて検証
- 詳細:
  - `test_helpers.go`: テストヘルパー関数、テストケース定義、テストデータ管理、セキュリティテスト、キャッシュテストなどの機能を提供
  - 各関数は単純な操作を行い、複雑なロジックを含まない
  - エラーハンドリングは適切に実装されている
  - コメントが詳細に書かれており、使用方法が明確

#### テストモック

- 場所: `tests/testutils/`
- 理由: テスト用のモック実装であり、それ自体をテストする必要はない
- 代替の検証方法: 実際のテストでの使用を通じて検証

#### テストデータ・モック専用ファイル

- 場所: `tests/unit/test_data.go`など
- 理由: テストデータやモックの定義ファイルであり、それ自体をテストする必要はない
- 代替の検証方法: 実際のテストでの使用を通じて検証
- 注意点: テストデータの整合性は手動レビューで確認

### 優先度の低いテスト対象

#### 認証・セキュリティ関連

- 場所: `internal/middleware/auth.go`, `internal/middleware/csrf.go`
- 理由: 認証とセキュリティ機能は統合テストで検証する必要がある
- 代替の検証方法: 統合テストと E2E テストでの検証
- 注意点: これらの機能は実際の環境での動作確認が重要
- 優先度: 中（統合テストの実装後に必要に応じてユニットテストを追加）

#### トランザクション処理

- 場所: `internal/repositories/transaction.go`
- 理由: トランザクション処理は統合テストで検証する必要がある
- 代替の検証方法: 統合テストでの検証
- 注意点: 実際のデータベース環境での動作確認が重要
- 優先度: 中（統合テストの実装後に必要に応じてユニットテストを追加）

#### アプリケーションエントリーポイント

- 場所: `cmd/api/main.go`
- 理由: これらは Go アプリケーションのエントリーポイント（`main`関数）であり、直接的なユニットテストは不要です。
  Go 公式 FAQ（[main 関数のテスト](https://go.dev/doc/faq#main_test)）や 2024 年のベストプラクティスでも、main 関数自体のテストは推奨されていません。
  代わりに、main から呼び出すビジネスロジックやサービス層を十分にテストしてください。
- 代替の検証方法:
  - main 関数が呼び出す各ロジックのユニットテスト・統合テスト
  - 実際のアプリケーション起動・E2E テスト
- 優先度: 低（他のテストが完了した後に必要に応じて追加）

## テストカバレッジの計測

### カバレッジ計測の除外設定

テストカバレッジ計測から特定のファイルを除外するには、以下のいずれかの方法を使用します：

1. `-coverpkg`フラグを使用する方法：

```bash
# 特定のパッケージのみを計測対象とする
go test -coverprofile=coverage.out -coverpkg=./internal/...,./pkg/... ./...
```

2. `-covermode=count`フラグを使用する方法：

```bash
# カバレッジモードを指定して計測
go test -covermode=count -coverprofile=coverage.out ./...
```

### カバレッジ計測の実行方法

```bash
# カバレッジの計測
go test -coverprofile=coverage.out ./...

# カバレッジレポートの生成（HTML形式）
go tool cover -html=coverage.out

# カバレッジレポートの生成（関数単位）
go tool cover -func=coverage.out
```

## テストの種類

### ユニットテスト

- 場所: `*_test.go`ファイル
- 目的: 個々の関数やメソッドの動作確認
- 実行方法: `go test ./...`
- ベストプラクティス:
  - テーブル駆動テストを活用
  - テストケースは理解しやすい構造にする
  - エラーメッセージは具体的で分かりやすく
  - テストは独立して実行可能にする

### 統合テスト

- 場所: `tests/integration/`
- 目的: 複数のコンポーネント間の連携確認
- 実行方法: `go test ./tests/integration/...`
- ベストプラクティス:
  - 実際の環境に近い状態でテスト
  - データベースや外部サービスとの連携を確認
  - エラーケースも含めて網羅的にテスト

### E2E テスト

- 場所: `tests/e2e/`
- 目的: システム全体の動作確認
- 実行方法: `go test ./tests/e2e/...`
- ベストプラクティス:
  - 実際のユーザー操作をシミュレート
  - パフォーマンスと安定性を確認
  - エラー発生時の挙動を確認

## テストの品質基準

1. テストカバレッジ

   - 目標: 80%以上
   - 計測対象: ビジネスロジックを含むコード
   - 除外: 上記のテスト対象外ファイル
   - 参考: [Go Coverage: Measuring and Improving Your Code Coverage in Go (2024)](https://medium.com/@keployio/go-coverage-measuring-and-improving-your-code-coverage-in-go-df7ce2a62313)

2. テストの独立性

   - 各テストは独立して実行可能であること
   - テスト間の依存関係を避けること
   - テストデータは各テストで適切に初期化すること

3. テストの可読性

   - テスト名は目的を明確に示すこと
   - テストケースは理解しやすい構造であること
   - エラーメッセージは具体的で分かりやすくすること

4. エラーメッセージ
   - エラー発生時に原因が特定しやすいこと
   - 期待値と実際の値の違いが明確であること
   - デバッグに必要な情報を含めること

## テストカバレッジ向上のための指針（2024 年最新ベストプラクティス）

- 重要なビジネスロジック・エラー処理・分岐・エッジケースを優先的にテスト
- main 関数や CLI エントリーポイントは直接テスト不要（main から呼び出すロジックをテストでカバー）
- テーブル駆動テストを活用し、網羅性と保守性を両立
- カバレッジ 100%を盲目的に目指さず、品質・実用性を優先
- CI/CD でカバレッジを自動計測し、80%程度を目安にする
- テストは「意味のあるカバレッジ」を重視し、単なる getter/setter や単純なラッパーは無理にテストしない

### 参考文献

- [Go Coverage: Measuring and Improving Your Code Coverage in Go (2024)](https://medium.com/@keployio/go-coverage-measuring-and-improving-your-code-coverage-in-go-df7ce2a62313)
- [Go 公式 FAQ: main 関数のテスト](https://go.dev/doc/faq#main_test)
- [Go Testing Best Practices (2024)](https://go.dev/doc/code.html#Testing)

---

### 例：カバレッジ計測コマンド

```sh
go test -coverprofile=coverage.out ./...
go tool cover -func=coverage.out
go tool cover -html=coverage.out
```
